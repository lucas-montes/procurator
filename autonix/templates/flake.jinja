
{# flake.jinja - Askama template for a modern, multi-system Nix flake using flake-utils #}
{
  description = "{{ self.description }}";

  inputs = {
    nixpkgs.url = "{{ self.inputs.nixpkgs }}";
    flake-utils.url = "github:numtide/flake-utils";
  };

  outputs = { self, nixpkgs, flake-utils, ... }@inputs:
    flake-utils.lib.eachDefaultSystem (system:
      let
        pkgs = import nixpkgs { inherit system; };
      in
      {
        packages = {
          {% for (name, pkg) in self.outputs.packages %}
          {{ name }} = pkgs.stdenv.mkDerivation {
            pname = "{{ pkg.name }}";
            version = "{{ pkg.metadata.version }}";
            src = ./.;

            buildInputs = with pkgs; [
              {{ pkg.toolchain.language }}
              {% for dep in pkg.dependencies %}
              {{ dep }}
              {% endfor %}
            ];

            meta = with pkgs.lib; {
              description = "{{ pkg.metadata.description_str() }}";
              {% if !pkg.metadata.license_str().is_empty() %}
              license = licenses.{{ pkg.metadata.license_str() }};
              {% endif %}
              maintainers = [
                {% for author in pkg.metadata.authors %}
                "{{ author }}"
                {% endfor %}
              ];
            };
          };
          {% endfor %}
        };

        devShells.default = pkgs.mkShell {
          buildInputs = with pkgs; [
            {% for tc in self.outputs.dev_shells.toolchains %}
            {{ tc.language }}
            {% endfor %}
            {% for dep in self.outputs.dev_shells.dependencies %}
            {{ dep }}
            {% endfor %}
          ];

          {% if !self.outputs.dev_shells.shell_hook_str().is_empty() %}
          shellHook = ''
            {{ self.outputs.dev_shells.shell_hook_str() }}
          '';
          {% endif %}
        };

        checks = {
          {% for (name, check) in self.outputs.checks %}
          {{ name }} = pkgs.runCommand "check-{{ name }}" {
            buildInputs = with pkgs; [
              {{ check.toolchain.language }}
              {% for dep in check.dependencies %}
              {{ dep }}
              {% endfor %}
            ];
          } ''
            {{ check.command }}
            touch $out
          '';
          {% endfor %}
        };
      }
    ) // {
      procurator = {
        services = [
          {% for svc in self.outputs.procurator.services %}
          {
            name = "{{ svc.name }}";
            version = "{{ svc.version_str() }}";
            {% if svc.has_port() %}
            port = {{ svc.port_value() }};
            {% endif %}
            {% if !svc.health_check_str().is_empty() %}
            healthCheck = "{{ svc.health_check_str() }}";
            {% endif %}
            dependsOn = [
              {% for dep in svc.depends_on %}
              "{{ dep }}"
              {% endfor %}
            ];
            envVars = {
              {% for (key, value) in svc.env_vars %}
              {{ key }} = "{{ value }}";
              {% endfor %}
            };
          }
          {% endfor %}
        ];

        project = {
          name = "{{ self.outputs.procurator.project.name }}";
          languages = [
            {% for lang in self.outputs.procurator.project.languages %}
            "{{ lang }}"
            {% endfor %}
          ];
          packageManagers = [
            {% for pm in self.outputs.procurator.project.package_managers %}
            "{{ pm }}"
            {% endfor %}
          ];
        };
      };
    };
}
