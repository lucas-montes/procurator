image: rust:1.75-alpine

variables:
  CARGO_HOME: $CI_PROJECT_DIR/.cargo
  RUST_BACKTRACE: "1"
  DATABASE_URL: "postgres://postgres:postgres@postgres:5432/test_db"
  REDIS_URL: "redis://redis:6379"

stages:
  - test
  - lint
  - build
  - deploy

# Cache dependencies across jobs
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .cargo/
    - target/

# Install system dependencies needed for compilation
.install-deps: &install-deps
  before_script:
    - apk add --no-cache musl-dev openssl-dev pkgconfig postgresql-dev curl

test:
  stage: test
  <<: *install-deps
  services:
    - name: postgres:15-alpine
      alias: postgres
      variables:
        POSTGRES_PASSWORD: postgres
        POSTGRES_DB: test_db
    - name: redis:7-alpine
      alias: redis
  script:
    - cargo test --all-features --workspace --verbose
    - cargo test --doc --workspace
  coverage: '/^\d+\.\d+% coverage/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: cobertura.xml
    expire_in: 1 week

test:integration:
  stage: test
  <<: *install-deps
  services:
    - name: postgres:15-alpine
      alias: postgres
      variables:
        POSTGRES_PASSWORD: postgres
        POSTGRES_DB: test_db
    - name: redis:7-alpine
      alias: redis
  script:
    - cargo test --test '*' --workspace
  only:
    - merge_requests
    - main

lint:clippy:
  stage: lint
  <<: *install-deps
  script:
    - rustup component add clippy
    - cargo clippy --all-targets --all-features --workspace -- -D warnings
  allow_failure: false

lint:fmt:
  stage: lint
  script:
    - rustup component add rustfmt
    - cargo fmt --all -- --check
  allow_failure: false

lint:audit:
  stage: lint
  script:
    - cargo install cargo-audit
    - cargo audit
  allow_failure: true

build:debug:
  stage: build
  <<: *install-deps
  script:
    - cargo build --workspace --verbose
  artifacts:
    paths:
      - target/debug/myapp-api
      - target/debug/myapp
    expire_in: 1 day

build:release:
  stage: build
  <<: *install-deps
  script:
    - cargo build --release --workspace --verbose
  artifacts:
    paths:
      - target/release/myapp-api
      - target/release/myapp
    expire_in: 1 week
  only:
    - tags
    - main

# Build Docker image
build:docker:
  stage: build
  image: docker:24-alpine
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA .
    - docker tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA $CI_REGISTRY_IMAGE:latest
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
    - docker push $CI_REGISTRY_IMAGE:latest
  only:
    - main
    - tags

# Deploy to staging
deploy:staging:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
  script:
    - echo "Deploying to staging environment"
    - ssh deploy@staging.example.com "docker pull $CI_REGISTRY_IMAGE:latest && docker-compose up -d"
  environment:
    name: staging
    url: https://staging.example.com
  only:
    - main
  when: manual

# Deploy to production
deploy:production:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
  script:
    - echo "Deploying to production environment"
    - ssh deploy@prod.example.com "docker pull $CI_REGISTRY_IMAGE:$CI_COMMIT_TAG && docker-compose up -d"
  environment:
    name: production
    url: https://example.com
  only:
    - tags
  when: manual
