{% extends "../base.html" %}

{% block title %}{{ repo_name }} - Flake - Procurator CI{% endblock %}

{% block content %}
<div class="breadcrumb">
    <a href="/">Home</a>
    <span class="separator">/</span>
    <a href="/{{ username }}">{{ username }}</a>
    <span class="separator">/</span>
    <span>{{ repo_name }}</span>
</div>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
    <h1>{{ username }}/{{ repo_name }}</h1>
    <div class="code-block" style="padding: 8px 12px; font-size: 0.8rem;">
        {{ git_url }}
    </div>
</div>

<div class="tabs">
    <a href="/{{ username }}/{{ repo_name }}" class="tab {% if active_tab == "builds" %}active{% endif %}">
        üî® Builds
    </a>
    <a href="/{{ username }}/{{ repo_name }}/files" class="tab {% if active_tab == "files" %}active{% endif %}">
        üìÅ Files
    </a>
    <a href="/{{ username }}/{{ repo_name }}/flake" class="tab {% if active_tab == "flake" %}active{% endif %}">
        ‚ùÑÔ∏è Flake
    </a>
    <a href="/{{ username }}/{{ repo_name }}/infrastructure" class="tab {% if active_tab == "infrastructure" %}active{% endif %}">
        üèóÔ∏è Infrastructure
    </a>
</div>

<h2 style="margin-bottom: 16px;">Flake Information</h2>

{% if let Some(metadata) = flake_metadata %}
<div class="grid grid-2" style="margin-bottom: 24px;">
    {% if let Some(description) = metadata.description %}
    <div class="card" style="grid-column: span 2;">
        <h3 class="card-title">Description</h3>
        <p style="margin-top: 8px; color: var(--text-secondary);">{{ description }}</p>
    </div>
    {% endif %}

    <div class="card">
        <h3 class="card-title">Packages</h3>
        {% if metadata.packages.is_empty() %}
        <p style="color: var(--text-secondary); margin-top: 8px;">No packages defined</p>
        {% else %}
        <ul class="list" style="margin-top: 8px;">
            {% for package in metadata.packages %}
            <li class="list-item" style="padding: 8px 0;">
                <code>{{ package }}</code>
            </li>
            {% endfor %}
        </ul>
        {% endif %}
    </div>

    <div class="card">
        <h3 class="card-title">Checks</h3>
        {% if metadata.checks.is_empty() %}
        <p style="color: var(--text-secondary); margin-top: 8px;">No checks defined</p>
        {% else %}
        <ul class="list" style="margin-top: 8px;">
            {% for check in metadata.checks %}
            <li class="list-item" style="padding: 8px 0;">
                <code>{{ check }}</code>
            </li>
            {% endfor %}
        </ul>
        {% endif %}
    </div>

    <div class="card">
        <h3 class="card-title">Dev Shells</h3>
        {% if metadata.dev_shells.is_empty() %}
        <p style="color: var(--text-secondary); margin-top: 8px;">No dev shells defined</p>
        {% else %}
        <ul class="list" style="margin-top: 8px;">
            {% for shell in metadata.dev_shells %}
            <li class="list-item" style="padding: 8px 0;">
                <code>{{ shell }}</code>
            </li>
            {% endfor %}
        </ul>
        {% endif %}
    </div>

    <div class="card">
        <h3 class="card-title">Apps</h3>
        {% if metadata.apps.is_empty() %}
        <p style="color: var(--text-secondary); margin-top: 8px;">No apps defined</p>
        {% else %}
        <ul class="list" style="margin-top: 8px;">
            {% for app in metadata.apps %}
            <li class="list-item" style="padding: 8px 0;">
                <code>{{ app }}</code>
            </li>
            {% endfor %}
        </ul>
        {% endif %}
    </div>

    {% if !metadata.nixos_modules.is_empty() %}
    <div class="card">
        <h3 class="card-title">NixOS Modules</h3>
        <ul class="list" style="margin-top: 8px;">
            {% for module in metadata.nixos_modules %}
            <li class="list-item" style="padding: 8px 0;">
                <code>{{ module }}</code>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}
</div>

<!-- Infrastructure Section -->
{% if let Some(infra) = metadata.infrastructure %}
<h2 style="margin-top: 32px; margin-bottom: 16px;">üèóÔ∏è Infrastructure Configuration</h2>

<div class="grid grid-2" style="margin-bottom: 24px;">
    <!-- Machines -->
    <div class="card" style="grid-column: span 2;">
        <h3 class="card-title">Machines</h3>
        {% if infra.machines.is_empty() %}
        <p style="color: var(--text-secondary); margin-top: 8px;">No machines defined</p>
        {% else %}
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; margin-top: 12px;">
            {% for (name, machine) in infra.machines %}
            <div style="border: 1px solid var(--border-color); border-radius: 6px; padding: 12px;">
                <h4 style="font-size: 1rem; margin-bottom: 8px;">{{ name }}</h4>
                <div class="meta-info" style="flex-direction: column; gap: 6px;">
                    <div class="meta-item">
                        <strong>CPU:</strong> {{ machine.cpu }} cores
                    </div>
                    <div class="meta-item">
                        <strong>Memory:</strong> {{ machine.memory.amount }} {{ machine.memory.unit }}
                    </div>
                    <div class="meta-item" style="flex-wrap: wrap;">
                        <strong>Roles:</strong>
                        <div style="display: flex; gap: 4px; flex-wrap: wrap; margin-top: 4px;">
                            {% for role in machine.roles %}
                            <span class="badge badge-info">{{ role }}</span>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <!-- Continuous Delivery -->
    <div class="card">
        <h3 class="card-title">Continuous Delivery</h3>
        <div class="meta-info" style="flex-direction: column; gap: 8px; margin-top: 12px;">
            <div class="meta-item">
                <strong>Tests:</strong>
                {% if infra.cd.tests %}
                <span class="badge badge-success">‚úì Enabled</span>
                {% else %}
                <span class="badge badge-error">‚úó Disabled</span>
                {% endif %}
            </div>
            <div class="meta-item">
                <strong>Build:</strong>
                {% if infra.cd.build %}
                <span class="badge badge-success">‚úì Enabled</span>
                {% else %}
                <span class="badge badge-error">‚úó Disabled</span>
                {% endif %}
            </div>
            <div class="meta-item">
                <strong>DST:</strong>
                {% if infra.cd.dst %}
                <span class="badge badge-success">‚úì Enabled</span>
                {% else %}
                <span class="badge badge-error">‚úó Disabled</span>
                {% endif %}
            </div>
            <div class="meta-item">
                <strong>Staging:</strong>
                {% if infra.cd.staging %}
                <span class="badge badge-success">‚úì Enabled</span>
                {% else %}
                <span class="badge badge-error">‚úó Disabled</span>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Rollback Configuration -->
    {% if infra.rollback.enabled %}
    <div class="card">
        <h3 class="card-title">Rollback Strategy</h3>
        <div class="meta-info" style="flex-direction: column; gap: 8px; margin-top: 12px;">
            <div class="meta-item">
                <strong>Enabled:</strong>
                <span class="badge badge-success">‚úì Yes</span>
            </div>

            {% if let Some(threshold) = infra.rollback.threshold %}
            <div style="margin-top: 8px;">
                <strong style="display: block; margin-bottom: 4px;">Thresholds:</strong>
                <div style="margin-left: 16px;">
                    {% if let Some(cpu) = threshold.cpu %}
                    <div class="meta-item">CPU: {{ cpu }}</div>
                    {% endif %}
                    {% if let Some(memory) = threshold.memory %}
                    <div class="meta-item">Memory: {{ memory.amount }} {{ memory.unit }}</div>
                    {% endif %}
                    {% if let Some(latency) = threshold.latency %}
                    <div style="margin-top: 4px;">
                        <div class="meta-item">Latency:</div>
                        <div style="margin-left: 16px; font-size: 0.875rem;">
                            {% if let Some(p99) = latency.p99 %}
                            <div>p99: {{ p99 }}</div>
                            {% endif %}
                            {% if let Some(p90) = latency.p90 %}
                            <div>p90: {{ p90 }}</div>
                            {% endif %}
                            {% if let Some(p50) = latency.p50 %}
                            <div>p50: {{ p50 }}</div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            {% if let Some(notification) = infra.rollback.notification %}
            {% if notification.enabled %}
            <div style="margin-top: 8px;">
                <strong style="display: block; margin-bottom: 4px;">Notifications:</strong>
                <div style="margin-left: 16px;">
                    {% if let Some(email) = notification.email %}
                    <div class="meta-item">üìß Email: {{ email.recipients.len() }} recipient(s)</div>
                    {% endif %}
                    {% if let Some(slack) = notification.slack %}
                    <div class="meta-item">üí¨ Slack: {{ slack.channel }}</div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Services (if present) -->
    {% if !infra.services.is_empty() %}
    <div class="card" style="grid-column: span 2;">
        <h3 class="card-title">Services</h3>
        <div style="margin-top: 12px;">
            <p style="color: var(--text-secondary); font-size: 0.875rem;">
                {{ infra.services.len() }} service(s) configured
            </p>
        </div>
    </div>
    {% endif %}
</div>
{% endif %}

<div class="card">
    <h3 class="card-title" style="margin-bottom: 16px;">Quick Commands</h3>
    <div style="display: flex; flex-direction: column; gap: 12px;">
        {% if !metadata.packages.is_empty() %}
        <div>
            <h4 style="font-size: 0.875rem; margin-bottom: 8px;">Build default package</h4>
            <div class="code-block">nix build {{ git_url }}</div>
        </div>
        {% endif %}

        {% if !metadata.dev_shells.is_empty() %}
        <div>
            <h4 style="font-size: 0.875rem; margin-bottom: 8px;">Enter dev shell</h4>
            <div class="code-block">nix develop {{ git_url }}</div>
        </div>
        {% endif %}

        <div>
            <h4 style="font-size: 0.875rem; margin-bottom: 8px;">Run checks</h4>
            <div class="code-block">nix flake check {{ git_url }}</div>
        </div>
    </div>
</div>

{% else %}
<div class="card">
    <div class="empty-state">
        <h3>Not a Nix Flake</h3>
        <p>This repository does not contain a valid flake.nix file, or flake metadata could not be retrieved.</p>
        <div style="margin-top: 24px; text-align: left; max-width: 500px; margin-left: auto; margin-right: auto;">
            <h4 style="margin-bottom: 12px;">To create a flake, add a flake.nix file:</h4>
            <div class="code-block">{
  description = "My project";

  inputs = {
    nixpkgs.url = "github:NixOS/nixpkgs/nixos-unstable";
  };

  outputs = { self, nixpkgs }: {
    packages.x86_64-linux.default =
      nixpkgs.legacyPackages.x86_64-linux.hello;
  };
}</div>
        </div>
    </div>
</div>
{% endif %}
{% endblock content %}
