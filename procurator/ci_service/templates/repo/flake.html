{% extends "../base.html" %}

{% block title %}{{ repo_name }} - Flake - Procurator CI{% endblock %}

{% block content %}
<div class="breadcrumb">
    <a href="/">Home</a>
    <span class="separator">/</span>
    <a href="/{{ username }}">{{ username }}</a>
    <span class="separator">/</span>
    <span>{{ repo_name }}</span>
</div>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
    <h1>{{ username }}/{{ repo_name }}</h1>
    <div class="code-block" style="padding: 8px 12px; font-size: 0.8rem;">
        {{ git_url }}
    </div>
</div>

<div class="tabs">
    <a href="/{{ username }}/{{ repo_name }}" class="tab {% if active_tab == "builds" %}active{% endif %}">
        üî® Builds
    </a>
    <a href="/{{ username }}/{{ repo_name }}/files" class="tab {% if active_tab == "files" %}active{% endif %}">
        üìÅ Files
    </a>
    <a href="/{{ username }}/{{ repo_name }}/flake" class="tab {% if active_tab == "flake" %}active{% endif %}">
        ‚ùÑÔ∏è Flake
    </a>
</div>

<h2 style="margin-bottom: 16px;">Flake Information</h2>

{% if let Some(metadata) = flake_metadata %}
<div class="grid grid-2" style="margin-bottom: 24px;">
    {% if let Some(description) = metadata.description %}
    <div class="card" style="grid-column: span 2;">
        <h3 class="card-title">Description</h3>
        <p style="margin-top: 8px; color: var(--text-secondary);">{{ description }}</p>
    </div>
    {% endif %}

    <div class="card">
        <h3 class="card-title">Packages</h3>
        {% if metadata.packages.is_empty() %}
        <p style="color: var(--text-secondary); margin-top: 8px;">No packages defined</p>
        {% else %}
        <ul class="list" style="margin-top: 8px;">
            {% for package in metadata.packages %}
            <li class="list-item" style="padding: 8px 0;">
                <code>{{ package }}</code>
            </li>
            {% endfor %}
        </ul>
        {% endif %}
    </div>

    <div class="card">
        <h3 class="card-title">Checks</h3>
        {% if metadata.checks.is_empty() %}
        <p style="color: var(--text-secondary); margin-top: 8px;">No checks defined</p>
        {% else %}
        <ul class="list" style="margin-top: 8px;">
            {% for check in metadata.checks %}
            <li class="list-item" style="padding: 8px 0;">
                <code>{{ check }}</code>
            </li>
            {% endfor %}
        </ul>
        {% endif %}
    </div>

    <div class="card">
        <h3 class="card-title">Dev Shells</h3>
        {% if metadata.dev_shells.is_empty() %}
        <p style="color: var(--text-secondary); margin-top: 8px;">No dev shells defined</p>
        {% else %}
        <ul class="list" style="margin-top: 8px;">
            {% for shell in metadata.dev_shells %}
            <li class="list-item" style="padding: 8px 0;">
                <code>{{ shell }}</code>
            </li>
            {% endfor %}
        </ul>
        {% endif %}
    </div>

    <div class="card">
        <h3 class="card-title">Apps</h3>
        {% if metadata.apps.is_empty() %}
        <p style="color: var(--text-secondary); margin-top: 8px;">No apps defined</p>
        {% else %}
        <ul class="list" style="margin-top: 8px;">
            {% for app in metadata.apps %}
            <li class="list-item" style="padding: 8px 0;">
                <code>{{ app }}</code>
            </li>
            {% endfor %}
        </ul>
        {% endif %}
    </div>

    {% if !metadata.nixos_modules.is_empty() %}
    <div class="card">
        <h3 class="card-title">NixOS Modules</h3>
        <ul class="list" style="margin-top: 8px;">
            {% for module in metadata.nixos_modules %}
            <li class="list-item" style="padding: 8px 0;">
                <code>{{ module }}</code>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}
</div>

<div class="card">
    <h3 class="card-title" style="margin-bottom: 16px;">Quick Commands</h3>
    <div style="display: flex; flex-direction: column; gap: 12px;">
        {% if !metadata.packages.is_empty() %}
        <div>
            <h4 style="font-size: 0.875rem; margin-bottom: 8px;">Build default package</h4>
            <div class="code-block">nix build {{ git_url }}</div>
        </div>
        {% endif %}

        {% if !metadata.dev_shells.is_empty() %}
        <div>
            <h4 style="font-size: 0.875rem; margin-bottom: 8px;">Enter dev shell</h4>
            <div class="code-block">nix develop {{ git_url }}</div>
        </div>
        {% endif %}

        <div>
            <h4 style="font-size: 0.875rem; margin-bottom: 8px;">Run checks</h4>
            <div class="code-block">nix flake check {{ git_url }}</div>
        </div>
    </div>
</div>

{% else %}
<div class="card">
    <div class="empty-state">
        <h3>Not a Nix Flake</h3>
        <p>This repository does not contain a valid flake.nix file, or flake metadata could not be retrieved.</p>
        <div style="margin-top: 24px; text-align: left; max-width: 500px; margin-left: auto; margin-right: auto;">
            <h4 style="margin-bottom: 12px;">To create a flake, add a flake.nix file:</h4>
            <div class="code-block">{
  description = "My project";

  inputs = {
    nixpkgs.url = "github:NixOS/nixpkgs/nixos-unstable";
  };

  outputs = { self, nixpkgs }: {
    packages.x86_64-linux.default =
      nixpkgs.legacyPackages.x86_64-linux.hello;
  };
}</div>
        </div>
    </div>
</div>
{% endif %}
{% endblock content %}
